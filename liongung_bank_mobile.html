<!doctype html>
<html lang="ru">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,viewport-fit=cover" />
<title>Liongung — Mobile</title>
<link rel="icon" href="data:;base64,iVBORw0KGgo=">
<style>
  :root{
    --bg:#08040a; --card:#100917; --muted:#b8a9d9; --text:#efe9ff;
    --accent:#8a5cff; --accent-2:#d24fff; --ok:#18b26b; --danger:#ff5468;
    --glass: rgba(255,255,255,0.03); --border: rgba(255,255,255,0.04);
    --radius:14px;
  }
  /* Reset */
  *{box-sizing:border-box;-webkit-tap-highlight-color:transparent}
  html,body{height:100%;margin:0;font-family:Inter,ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,"Helvetica Neue",Arial;color:var(--text);background:linear-gradient(180deg,#040205 0%, #08040a 60%);-webkit-font-smoothing:antialiased}
  /* App shell */
  .app{max-width:460px;margin:0 auto;min-height:100vh;display:flex;flex-direction:column;position:relative}
  header.appbar{position:sticky;top:0;background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));backdrop-filter: blur(8px);border-bottom:1px solid var(--border);padding:12px 16px;display:flex;align-items:center;gap:12px;z-index:30}
  .logo{width:44px;height:44px;border-radius:10px;background:conic-gradient(from 200deg,var(--accent) 0 45%,var(--accent-2) 45% 80%,#6f3cff 80% 100%);box-shadow:0 6px 20px rgba(138,92,255,0.12) inset;}
  .brand{display:flex;flex-direction:column}
  .brand h1{font-size:16px;margin:0;line-height:1}
  .brand .sub{font-size:12px;color:var(--muted);margin-top:2px}
  main{flex:1;padding:14px 12px 86px;overflow:auto}
  /* Cards and layout */
  .card{background:linear-gradient(180deg,var(--card),rgba(10,6,12,0.9));border:1px solid var(--border);border-radius:var(--radius);padding:12px;margin-bottom:12px;box-shadow:0 6px 18px rgba(0,0,0,0.5)}
  .row{display:flex;gap:8px;align-items:center}
  .pill{font-size:12px;padding:6px 8px;border-radius:999px;background:var(--glass);border:1px solid rgba(255,255,255,0.02);}
  .big{font-size:20px;font-weight:700}
  label{font-size:12px;color:var(--muted);display:block;margin-bottom:6px}
  input[type="text"],input[type="number"],select{width:100%;padding:12px;border-radius:12px;border:1px solid var(--border);background:transparent;color:var(--text);font-size:15px}
  .muted{color:var(--muted);font-size:13px}
  .controls{display:flex;gap:8px;margin-top:10px}
  .btn{flex:0 0 auto;padding:10px 12px;border-radius:12px;border:1px solid var(--border);background:linear-gradient(180deg,#14101a,#0a0610);color:var(--text);font-weight:700;cursor:pointer}
  .btn.full{flex:1;text-align:center}
  .btn.primary{background:linear-gradient(90deg,var(--accent),var(--accent-2));color:#0b0311;border:none}
  .btn.positive{background:var(--ok);color:#052015;border:none}
  .btn.danger{background:var(--danger);color:#30090d;border:none}
  .tx-list{display:grid;gap:8px;max-height:260px;overflow:auto;padding-right:6px}
  .tx{display:flex;justify-content:space-between;align-items:center;padding:10px;border-radius:10px;background:linear-gradient(180deg,#12071a,#0c0711);border:1px solid var(--border)}
  .small{font-size:13px;color:var(--muted)}
  footer.nav{position:fixed;left:50%;transform:translateX(-50%);bottom:12px;width:calc(100% - 28px);max-width:460px;background:linear-gradient(180deg,rgba(10,6,12,0.9),rgba(8,4,10,0.95));border-radius:18px;padding:8px;border:1px solid var(--border);display:flex;gap:6px;justify-content:space-between;align-items:center;z-index:40;box-shadow:0 12px 40px rgba(0,0,0,0.6)}
  .nav-btn{flex:1;padding:8px;border-radius:12px;text-align:center;color:var(--muted);font-size:12px;border:none;background:transparent;cursor:pointer;display:flex;flex-direction:column;align-items:center;gap:6px}
  .nav-btn.active{background:linear-gradient(180deg,rgba(138,92,255,0.12),rgba(210,79,255,0.06));color:var(--text)}
  .icon{width:20px;height:20px;display:block;opacity:0.95}
  /* responsive tweaks */
  @media(min-width:900px){
    .app{border-left:1px solid rgba(255,255,255,0.02);border-right:1px solid rgba(255,255,255,0.02);margin-top:20px;border-radius:18px;overflow:hidden}
    footer.nav{position:sticky;bottom:0;transform:none;left:0;width:100%;border-radius:0;padding:10px}
  }
</style>
</head>
<body>
<div class="app" id="app">
  <header class="appbar">
    <div class="logo" aria-hidden="true"></div>
    <div class="brand">
      <h1>Liongung</h1>
      <div class="sub">Быстрый интерфейс — мобильный вид</div>
    </div>
  </header>

  <main id="main">
    <!-- DASHBOARD -->
    <section id="view-dashboard" class="view">
      <div class="card" id="card-balance">
        <div class="row" style="justify-content:space-between;align-items:center">
          <div>
            <div class="pill">Счета</div>
            <div class="big" id="displayTotal">—</div>
            <div class="small" id="displayTotalSub">Итого во всех валютах</div>
          </div>
          <div style="min-width:110px;text-align:right">
            <div class="small">USD балансы</div>
            <div id="miniUsd" class="big">—</div>
          </div>
        </div>
        <div style="height:8px"></div>
        <div id="balances" style="display:grid;gap:8px"></div>
        <div class="controls" style="margin-top:12px">
          <button class="btn primary" id="earnBtn">Заработать $100–$200</button>
          <button class="btn" id="openQuickSend">Отправить</button>
        </div>
      </div>

      <div class="card">
        <div class="row" style="justify-content:space-between;align-items:center">
          <div><div class="pill">Быстрый обмен</div><div class="small">Конвертация между вашими счетами</div></div>
          <div class="small" id="rateInfo">—</div>
        </div>
        <div style="height:12px"></div>
        <div class="row" style="gap:8px">
          <div style="width:44%">
            <label>Из</label>
            <select id="xFrom"></select>
          </div>
          <div style="width:44%">
            <label>В</label>
            <select id="xTo"></select>
          </div>
        </div>
        <div style="height:8px"></div>
        <div>
          <label>Сумма</label>
          <input type="number" id="xAmount" placeholder="0.00" min="0" step="0.01" />
        </div>
        <div class="controls" style="margin-top:10px">
          <button class="btn full" id="xCalcBtn">Рассчитать</button>
          <button class="btn positive" id="xDoBtn">Поменять</button>
        </div>
        <div style="height:8px"></div>
        <div id="xResult" class="small"></div>
      </div>

      <div class="card">
        <div class="row" style="justify-content:space-between">
          <div><div class="pill">История</div><div class="small">Последние операции</div></div>
          <button class="btn" id="openHistory">Все</button>
        </div>
        <div style="height:8px"></div>
        <div id="lastTx" class="tx-list"></div>
      </div>
    </section>

    <!-- SEND -->
    <section id="view-send" class="view" style="display:none">
      <div class="card">
        <div class="row" style="justify-content:space-between;align-items:center">
          <div><div class="pill">Перевести</div><div class="small">Отправка другому пользователю</div></div>
          <button class="btn" id="backDash1">Назад</button>
        </div>
        <div style="height:10px"></div>
        <label>Получатель</label>
        <input type="text" id="sRecipient" placeholder="Имя или ник" />
        <div style="display:flex;gap:8px;margin-top:8px">
          <div style="width:50%">
            <label>Сумма</label>
            <input type="number" id="sAmount" placeholder="0.00" min="0" step="0.01" />
          </div>
          <div style="width:50%">
            <label>Валюта</label>
            <select id="sCurr"></select>
          </div>
        </div>
        <label style="margin-top:8px">Комментарий</label>
        <input type="text" id="sNote" placeholder="За что перевод" />
        <div class="controls" style="margin-top:10px">
          <button class="btn positive" id="sSendBtn">Отправить</button>
          <button class="btn" id="openSelfTransfer">Между своими</button>
        </div>
        <div style="height:8px"></div>
        <div id="sMsg" class="small"></div>
      </div>

      <div class="card">
        <div class="pill">Последние операции</div>
        <div id="lastTx2" class="tx-list" style="margin-top:8px"></div>
      </div>
    </section>

    <!-- SELF TRANSFER -->
    <section id="view-self" class="view" style="display:none">
      <div class="card">
        <div class="row" style="justify-content:space-between;align-items:center"><div><div class="pill">Между своими</div><div class="small">Перевести между счетами</div></div><button class="btn" id="backDash2">Назад</button></div>
        <div style="height:10px"></div>
        <div class="row" style="gap:8px">
          <div style="width:48%">
            <label>Из</label>
            <select id="selfFrom"></select>
          </div>
          <div style="width:48%">
            <label>В</label>
            <select id="selfTo"></select>
          </div>
        </div>
        <div style="height:8px"></div>
        <label>Сумма</label>
        <input type="number" id="selfAmount" placeholder="0.00" min="0" step="0.01" />
        <div class="controls" style="margin-top:10px">
          <button class="btn primary full" id="selfXchgBtn">Перекинуть</button>
        </div>
        <div style="height:8px"></div>
        <div id="selfMsg" class="small"></div>
      </div>
    </section>

    <!-- CONVERT PAGE -->
    <section id="view-convert" class="view" style="display:none">
      <div class="card">
        <div class="row" style="justify-content:space-between;align-items:center"><div><div class="pill">Конвертер</div><div class="small">Фиксированные курсы</div></div><button class="btn" id="backDash3">Назад</button></div>
        <div style="height:10px"></div>
        <div class="row" style="gap:8px">
          <div style="width:48%">
            <label>Из</label><select id="cFrom"></select>
          </div>
          <div style="width:48%">
            <label>В</label><select id="cTo"></select>
          </div>
        </div>
        <div style="height:8px"></div>
        <label>Сумма</label>
        <input type="number" id="cAmount" placeholder="0.00" min="0" step="0.01"/>
        <div style="height:8px"></div>
        <div class="controls">
          <button class="btn full" id="cCalc">Рассчитать</button>
          <button class="btn positive" id="cSwap">Поменять</button>
        </div>
        <div style="height:8px"></div>
        <div id="cOut" class="small"></div>
        <div id="cRatesInfo" class="muted" style="margin-top:8px"></div>
      </div>
    </section>

    <!-- CARDS -->
    <section id="view-cards" class="view" style="display:none">
      <div class="card">
        <div class="row" style="justify-content:space-between;align-items:center"><div><div class="pill">Карты</div><div class="small">Виртуальные карты</div></div><button class="btn" id="backDash4">Назад</button></div>
        <div style="height:10px"></div>
        <label>Платёжная система</label>
        <select id="cardNet"></select>
        <label style="margin-top:8px">Имя на карте</label>
        <input type="text" id="cardName" placeholder="IVAN IVANOV" />
        <div class="controls" style="margin-top:10px">
          <button class="btn primary" id="issueCard">Выпустить карту</button>
        </div>
        <div style="height:10px"></div>
        <div id="cardsList" class="cards-wrap"></div>
      </div>
    </section>

    <!-- INVEST -->
    <section id="view-invest" class="view" style="display:none">
      <div class="card">
        <div class="row" style="justify-content:space-between;align-items:center"><div><div class="pill">Инвестиции</div><div class="small">Гибкий вклад — 5% годовых</div></div><button class="btn" id="backDash5">Назад</button></div>
        <div style="height:10px"></div>
        <label>Сумма (USD)</label><input type="number" id="ivAmount" placeholder="0.00" min="0" step="0.01"/>
        <div class="controls" style="margin-top:10px">
          <button class="btn positive" id="ivDeposit">Вложить</button>
          <button class="btn" id="ivHarvest">Снять доход</button>
          <button class="btn danger" id="ivWithdraw">Вывести</button>
          <button class="btn" id="ivRefresh">Обновить</button>
        </div>
        <div style="height:10px"></div>
        <div id="ivState" class="small"></div>
        <canvas id="investChart" style="margin-top:10px;background:transparent;border-radius:8px"></canvas>
      </div>
    </section>

    <!-- HISTORY PAGE -->
    <section id="view-history" class="view" style="display:none">
      <div class="card">
        <div class="row" style="justify-content:space-between;align-items:center"><div><div class="pill">История</div><div class="small">Все операции</div></div><button class="btn" id="backDash6">Назад</button></div>
        <div style="height:10px"></div>
        <div id="txAll" class="tx-list"></div>
      </div>
    </section>

  </main>

  <!-- Bottom nav -->
  <footer class="nav" role="navigation" aria-label="Главная навигация">
    <button class="nav-btn active" data-view="dashboard" id="nav-dashboard"><svg class="icon" viewBox="0 0 24 24" fill="none"><path d="M3 13h8V3H3v10zM13 21h8V11h-8v10zM3 21h8v-6H3v6zM13 3v6h8V3h-8z" fill="currentColor"/></svg><span>Обзор</span></button>
    <button class="nav-btn" data-view="send" id="nav-send"><svg class="icon" viewBox="0 0 24 24" fill="none"><path d="M2 21l21-9L2 3v7l15 2-15 2v7z" fill="currentColor"/></svg><span>Переводы</span></button>
    <button class="nav-btn" data-view="convert" id="nav-convert"><svg class="icon" viewBox="0 0 24 24" fill="none"><path d="M12 2v4M12 18v4M4.93 4.93l2.83 2.83M16.24 16.24l2.83 2.83M2 12h4M18 12h4" stroke="currentColor" stroke-width="1.2" stroke-linecap="round" stroke-linejoin="round"/></svg><span>Обмен</span></button>
    <button class="nav-btn" data-view="cards" id="nav-cards"><svg class="icon" viewBox="0 0 24 24" fill="none"><path d="M2 7h20v10H2zM2 11h20" stroke="currentColor" stroke-width="1.2" stroke-linecap="round"/></svg><span>Карты</span></button>
    <button class="nav-btn" data-view="invest" id="nav-invest"><svg class="icon" viewBox="0 0 24 24" fill="none"><path d="M3 17l6-6 4 4 8-8" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round"/></svg><span>Инвест</span></button>
  </footer>
</div>

<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.3.0/dist/chart.umd.min.js"></script>

<script>
/* =========================
   Логика приложения (mobile)
   ========================= */
const CURRENCIES = ["USD","EUR","GBP"];
const DEFAULT_STATE = {
  balances: { USD: 500, EUR: 300, GBP: 200 },
  rates: { USD:1, EUR:0.92, GBP:0.78 },
  spread: 0.002,
  tx: [],
  cards: [],
  invest: { apr: 0.05, principalUSD: 0, accruedUSD: 0, lastTs: Date.now(), history: [] }
};
const CARD_NETWORKS = ["Visa","Mastercard","American Express","Discover","UnionPay","JCB","MIR","Maestro","Diners Club","RuPay","Elo"];

// ---- Storage ----
let state = loadState();
function loadState(){
  try{
    const raw = localStorage.getItem("liongungBankState_v2");
    if(!raw) return structuredClone(DEFAULT_STATE);
    const st = JSON.parse(raw);
    // ensure fields exist
    st.balances = st.balances || {};
    for(const c of CURRENCIES) if(!(c in st.balances)) st.balances[c] = DEFAULT_STATE.balances[c] || 0;
    st.rates = st.rates || DEFAULT_STATE.rates;
    if(typeof st.spread !== "number") st.spread = DEFAULT_STATE.spread;
    st.tx = st.tx || [];
    st.cards = st.cards || [];
    st.invest = st.invest || structuredClone(DEFAULT_STATE.invest);
    if(!Array.isArray(st.invest.history) || st.invest.history.length===0) st.invest.history = genInvestHistory(st.invest.principalUSD || 0);
    return st;
  }catch(e){
    console.error(e);
    return structuredClone(DEFAULT_STATE);
  }
}
function saveState(){ try{ localStorage.setItem("liongungBankState_v2", JSON.stringify(state)); }catch(e){console.error(e);} }

// ---- Utils ----
const fmt = n => Number(n).toLocaleString('ru-RU',{minimumFractionDigits:2,maximumFractionDigits:2});
function addTx(type, desc, amount, currency){
  state.tx.unshift({id: crypto.randomUUID(), ts: Date.now(), type, desc, amount, currency});
  if(state.tx.length>300) state.tx.length = 300;
  saveState(); renderHistoryViews();
}

// fake card number
function genCardNumber(){
  let d=[9];
  for(let i=1;i<16;i++) d.push(Math.floor(Math.random()*10));
  const luhn = arr=>{let s=0;for(let i=0;i<16;i++){let dd=arr[15-i]; if(i%2===1){dd*=2; if(dd>9) dd-=9;} s+=dd;} return s%10===0};
  if(luhn(d)) d[15] = (d[15]+1)%10;
  return d.join('').replace(/(\d{4})(?=\d)/g,'$1 ').trim();
}

// invest history generator
function genInvestHistory(base){
  const pts = 12;
  const arr = [];
  let v = Math.max(0, base);
  for(let i=pts-1;i>=0;i--){
    const noise = (Math.random()*2 -1) * Math.min(5, Math.max(1, v*0.01));
    v = Math.max(0, v + noise + (base? base*0.01: 0));
    arr.unshift({ts: Date.now() - i*30*24*3600*1000, value: Number(v.toFixed(2))});
  }
  return arr;
}

// rates and conversion
function calcRate(from,to){
  if(from===to) return 1;
  const toUSD = (val, cur) => (cur==='USD'? val : val / state.rates[cur]);
  const fromUSD = (val, cur) => (cur==='USD'? val : val * state.rates[cur]);
  return fromUSD(toUSD(1, from), to);
}
function convert(from,to,amount,doExchange=false){
  amount = Number(amount);
  if(!(amount>0)) return {ok:false,msg:'Введите сумму'};
  if(from===to) return {ok:false,msg:'Выберите разные валюты'};
  const r = calcRate(from,to);
  const eff = doExchange ? (r*(1-state.spread)) : r;
  const out = amount * eff;
  if(doExchange){
    if(state.balances[from] < amount) return {ok:false,msg:'Недостаточно средств'};
    state.balances[from] -= amount;
    state.balances[to] += out;
    saveState(); renderAll();
    addTx('Обмен', `${fmt(amount)} ${from} → ${fmt(out)} ${to}`, 0, to);
  }
  return {ok:true,msg:`${fmt(amount)} ${from} ≈ ${fmt(out)} ${to}`, out};
}

// send
function send(recipient, amount, curr, note=''){
  if(!recipient) return {ok:false,msg:'Укажите получателя'};
  amount = Number(amount);
  if(!(amount>0)) return {ok:false,msg:'Сумма должна быть больше 0'};
  if(state.balances[curr] < amount) return {ok:false,msg:'Недостаточно средств'};
  state.balances[curr] -= amount;
  saveState(); renderAll();
  addTx('Перевод', `${recipient}${note? ' • '+note:''}`, -amount, curr);
  return {ok:true,msg:`Отправлено ${fmt(amount)} ${curr}`};
}

// self transfer convenience
function selfTransfer(from,to,amount){
  // just call convert with doExchange true
  return convert(from,to,amount,true);
}

// invest accrual
function accrueInvest(){
  const inv = state.invest;
  const now = Date.now();
  const dt = Math.max(0, now - (inv.lastTs || now));
  if(dt>0 && inv.principalUSD>0){
    const days = dt/86400000;
    const add = inv.principalUSD * inv.apr * (days/365);
    inv.accruedUSD += add;
  }
  inv.lastTs = now;
  // push history snapshot
  pushInvestHistory(inv.principalUSD + inv.accruedUSD);
  saveState();
}
function pushInvestHistory(value){
  const h = state.invest.history || [];
  h.push({ts:Date.now(), value: Number(value.toFixed(2))});
  if(h.length>36) h.shift();
  state.invest.history = h;
}

// ---- Rendering ----
function renderBalances(){
  const root = document.getElementById('balances');
  root.innerHTML = '';
  CURRENCIES.forEach(c=>{
    const el = document.createElement('div');
    el.className = 'row card';
    el.style.padding = '10px';
    el.innerHTML = `<div style="flex:1"><div class="pill">${c}</div><div class="small">Доступно</div></div><div class="big">${fmt(state.balances[c])} ${c}</div>`;
    root.appendChild(el);
  });
  updateTotals();
  // fill selects
  ['qCurr','sCurr','xFrom','xTo','cFrom','cTo','selfFrom','selfTo'].forEach(id=>{
    const sel = document.getElementById(id);
    if(!sel) return;
    const keep = sel.value;
    sel.innerHTML = CURRENCIES.map(c=>`<option value="${c}">${c}</option>`).join('');
    if(keep && CURRENCIES.includes(keep)) sel.value = keep;
  });
  // card networks
  const net = document.getElementById('cardNet');
  if(net){
    const k = net.value;
    net.innerHTML = CARD_NETWORKS.map(n=>`<option value="${n}">${n}</option>`).join('');
    if(k && CARD_NETWORKS.includes(k)) net.value = k;
  }
}

function updateTotals(){
  // compute total in USD
  let total = 0;
  for(const c of CURRENCIES){
    const val = Number(state.balances[c]) || 0;
    total += (c==='USD')? val : val / state.rates[c];
  }
  document.getElementById('displayTotal').textContent = `${fmt(total)} USD`;
  let usdOnly = Number(state.balances.USD || 0);
  document.getElementById('miniUsd').textContent = `${fmt(usdOnly)} USD`;
  ensureRatesInfo();
}

function ensureRatesInfo(){
  const pairs = [
    `1 USD = ${fmt(state.rates.EUR)} EUR`,
    `1 USD = ${fmt(state.rates.GBP)} GBP`
  ];
  const el = document.getElementById('rateInfo');
  if(el) el.textContent = pairs.join(' • ');
}

function renderHistoryViews(){
  const last = state.tx.slice(0,6);
  const root = document.getElementById('lastTx');
  const root2 = document.getElementById('lastTx2');
  [root,root2].forEach(r=>{ if(r) r.innerHTML = last.map(tx=>`<div class="tx"><div><div><strong>${tx.type}</strong> — ${tx.desc}</div><div class="small">${new Date(tx.ts).toLocaleString()}</div></div><div class="${tx.amount>=0?'small':'small'}">${tx.amount>=0?'+':''}${fmt(tx.amount)} ${tx.currency}</div></div>`).join('') || '<div class="small">Пока нет операций</div>' });
  const all = document.getElementById('txAll');
  if(all) all.innerHTML = state.tx.map(tx=>`<div class="tx"><div><div><strong>${tx.type}</strong> — ${tx.desc}</div><div class="small">${new Date(tx.ts).toLocaleString()}</div></div><div class="${tx.amount>=0?'small':'small'}">${tx.amount>=0?'+':''}${fmt(tx.amount)} ${tx.currency}</div></div>`).join('') || '<div class="small">История пуста</div>';
}

function renderCards(){
  const root = document.getElementById('cardsList');
  if(!root) return;
  if(state.cards.length===0){ root.innerHTML = '<div class="small muted">Карт пока нет</div>'; return; }
  root.innerHTML = state.cards.map(c=>`<div class="card" style="padding:10px"><div class="row" style="justify-content:space-between"><div><strong>${c.network}</strong><div class="small">Имя: ${c.name}</div></div><div><button class="btn" data-id="${c.id}" onclick="removeCard('${c.id}')">Удалить</button></div></div><div style="height:8px"></div><div class="small">${c.number}</div><div class="small">Срок: ${c.exp} • CVV: ${c.cvv}</div></div>`).join('');
}

function renderInvest(){
  accrueInvest();
  const inv = state.invest;
  const el = document.getElementById('ivState');
  el.innerHTML = `Вклад: <strong>${fmt(inv.principalUSD)} USD</strong><br>Накоплено: <strong>${fmt(inv.accruedUSD)} USD</strong><br>Ставка: <strong>${(inv.apr*100).toFixed(2)}%</strong><div class="small">Обновлено: ${new Date(inv.lastTs).toLocaleString()}</div>`;
  updateInvestChart();
}

function renderAll(){
  renderBalances();
  renderHistoryViews();
  renderCards();
  renderInvest();
}

// ---- Chart (invest) ----
let investChart = null;
function initInvestChart(){
  const ctx = document.getElementById('investChart').getContext('2d');
  investChart = new Chart(ctx,{
    type:'line',
    data:{ labels: [], datasets:[{label:'USD', data:[], fill:true, tension:0.3, borderWidth:2}] },
    options:{ responsive:true, plugins:{legend:{display:false}}, scales:{x:{display:false}, y:{beginAtZero:true}} }
  });
}
function updateInvestChart(){
  if(!investChart) initInvestChart();
  const h = state.invest.history || [];
  investChart.data.labels = h.map(p=>new Date(p.ts).toLocaleDateString());
  investChart.data.datasets[0].data = h.map(p=>p.value);
  investChart.update();
}

// ---- UI binding ----
function showView(id){
  document.querySelectorAll('.view').forEach(v=>v.style.display='none');
  const el = document.getElementById('view-'+id);
  if(el) el.style.display = 'block';
  // update nav active
  document.querySelectorAll('.nav-btn').forEach(b=>b.classList.remove('active'));
  const nb = document.querySelector(`[data-view="${id}"]`);
  if(nb) nb.classList.add('active');
  // small render hooks
  if(id==='dashboard') renderAll();
  if(id==='history') renderHistoryViews();
  if(id==='invest') renderInvest();
}

document.querySelectorAll('.nav-btn').forEach(b=>{
  b.addEventListener('click', ()=> showView(b.dataset.view));
});

// quick open buttons
document.getElementById('openQuickSend').addEventListener('click', ()=> showView('send'));
document.getElementById('openHistory').addEventListener('click', ()=> showView('history'));
document.getElementById('openSelfTransfer').addEventListener('click', ()=> showView('self'));

// back buttons
['backDash1','backDash2','backDash3','backDash4','backDash5','backDash6'].forEach(id=>{
  const el = document.getElementById(id);
  if(el) el.addEventListener('click', ()=> showView('dashboard'));
});

// Earn
document.getElementById('earnBtn').addEventListener('click', ()=>{
  const add = Math.floor(100 + Math.random()*101);
  state.balances.USD += add;
  saveState(); renderAll();
  addTx('Заработок','Бонус', add, 'USD');
});

// Quick convert (dashboard)
document.getElementById('xCalcBtn').addEventListener('click', ()=>{
  const r = convert(document.getElementById('xFrom').value, document.getElementById('xTo').value, document.getElementById('xAmount').value, false);
  const el = document.getElementById('xResult');
  el.textContent = r.msg; el.style.color = r.ok ? '' : 'var(--danger)';
});
document.getElementById('xDoBtn').addEventListener('click', ()=>{
  const r = convert(document.getElementById('xFrom').value, document.getElementById('xTo').value, document.getElementById('xAmount').value, true);
  const el = document.getElementById('xResult');
  el.textContent = r.msg; el.style.color = r.ok ? '' : 'var(--danger)';
  if(r.ok) document.getElementById('xAmount').value='';
});

// Send page
document.getElementById('sSendBtn').addEventListener('click', ()=>{
  const r = send(document.getElementById('sRecipient').value.trim(), document.getElementById('sAmount').value, document.getElementById('sCurr').value, document.getElementById('sNote').value.trim());
  const el = document.getElementById('sMsg');
  el.textContent = r.msg; el.style.color = r.ok ? '' : 'var(--danger)';
  if(r.ok){ document.getElementById('sAmount').value=''; document.getElementById('sRecipient').value=''; document.getElementById('sNote').value=''; renderAll(); }
  renderHistoryViews();
});

// Self transfer
document.getElementById('selfXchgBtn').addEventListener('click', ()=>{
  const from = document.getElementById('selfFrom').value, to = document.getElementById('selfTo').value, amt = document.getElementById('selfAmount').value;
  const r = selfTransfer(from,to,amt);
  const el = document.getElementById('selfMsg'); el.textContent = r.msg; el.style.color = r.ok ? '' : 'var(--danger)';
  if(r.ok){ document.getElementById('selfAmount').value=''; renderAll(); renderHistoryViews(); }
});

// Converter page
document.getElementById('cCalc').addEventListener('click', ()=>{
  const r = convert(document.getElementById('cFrom').value, document.getElementById('cTo').value, document.getElementById('cAmount').value, false);
  const out = document.getElementById('cOut');
  out.textContent = r.msg; out.style.color = r.ok ? '' : 'var(--danger)';
});
document.getElementById('cSwap').addEventListener('click', ()=>{
  const r = convert(document.getElementById('cFrom').value, document.getElementById('cTo').value, document.getElementById('cAmount').value, true);
  const out = document.getElementById('cOut');
  out.textContent = r.msg; out.style.color = r.ok ? '' : 'var(--danger)';
  if(r.ok) document.getElementById('cAmount').value='';
});

// Cards
document.getElementById('issueCard').addEventListener('click', ()=>{
  const net = document.getElementById('cardNet').value, name = document.getElementById('cardName').value || 'CARDHOLDER';
  const id = crypto.randomUUID(), number = genCardNumber(), exp = `${String(Math.floor(1+Math.random()*12)).padStart(2,'0')}/${String((new Date().getFullYear()+4)%100).padStart(2,'0')}`;
  state.cards.unshift({id, network: net, name: name.toUpperCase(), number, exp, cvv:'***'});
  saveState(); renderCards(); addTx('Карта', 'Выпуск карты '+net, 0, 'USD'); alert('Карта выпущена: '+net);
});

// removeCard exposed globally already via window function below

// Invest controls
document.getElementById('ivDeposit').addEventListener('click', ()=>{
  accrueInvest();
  const amt = Number(document.getElementById('ivAmount').value);
  if(!(amt>0)) return alert('Введите сумму');
  if(state.balances.USD < amt) return alert('Недостаточно USD');
  state.balances.USD -= amt;
  state.invest.principalUSD += amt;
  saveState(); renderAll(); addTx('Инвестиции','Вложение', -amt, 'USD');
  document.getElementById('ivAmount').value='';
});
document.getElementById('ivHarvest').addEventListener('click', ()=>{
  accrueInvest();
  const gain = state.invest.accruedUSD;
  if(gain<=0.001) return alert('Дохода нет');
  state.invest.accruedUSD = 0;
  state.balances.USD += gain;
  saveState(); renderAll(); addTx('Инвестиции','Снятие дохода', gain, 'USD');
});
document.getElementById('ivWithdraw').addEventListener('click', ()=>{
  accrueInvest();
  const p = state.invest.principalUSD;
  if(p<=0.001) return alert('Вклада нет');
  state.invest.principalUSD = 0; state.balances.USD += p;
  saveState(); renderAll(); addTx('Инвестиции','Вывод вклада', p, 'USD');
});
document.getElementById('ivRefresh').addEventListener('click', ()=>{ renderInvest(); });

// remove card function for inline handlers
function removeCard(id){
  state.cards = state.cards.filter(c=>c.id!==id);
  saveState(); renderCards(); renderAll();
}
window.removeCard = removeCard;

// ---- Init ----
renderAll();
document.querySelectorAll('[data-view]').forEach(b=>{ if(b.dataset.view==='dashboard') b.classList.add('active'); });
// set default selects
['xFrom','xTo','cFrom','cTo','sCurr','selfFrom','selfTo'].forEach(id=>{ const el=document.getElementById(id); if(el) el.value='USD'; });
document.getElementById('xTo').value='EUR'; document.getElementById('cTo').value='EUR';

// init chart
initInvestChart();
updateInvestChart();

</script>

</body>
</html>
